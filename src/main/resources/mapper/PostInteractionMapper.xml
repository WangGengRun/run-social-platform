<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.run.runsocialplatform.module.post.mapper.PostInteractionMapper">

    <!-- 查询评论列表（支持嵌套回复） -->
    <resultMap id="CommentVOMap" type="com.run.runsocialplatform.module.post.model.vo.CommentVO">
        <id column="id" property="id"/>
        <result column="postId" property="postId"/>
        <result column="userId" property="userId"/>
        <result column="username" property="username"/>
        <result column="realName" property="realName"/>
        <result column="avatar" property="avatar"/>
        <result column="content" property="content"/>
        <result column="parentId" property="parentId"/>
        <result column="isSelf" property="isSelf"/>
        <result column="createdAt" property="createdAt"/>
        <result column="updatedAt" property="updatedAt"/>
        <collection property="replies" ofType="com.run.runsocialplatform.module.post.model.vo.CommentVO"
                    select="selectReplies" column="{parentId=id,postId=postId,currentUserId=currentUserId}"/>
    </resultMap>

    <!-- 查询评论列表（一级评论） -->
    <select id="selectComments" resultMap="CommentVOMap">
        SELECT
            pi.id,
            pi.post_id as postId,
            pi.user_id as userId,
            u.username,
            a.real_name as realName,
            u.avatar,
            pi.content,
            pi.parent_id as parentId,
            #{currentUserId} as currentUserId,
            CASE
                WHEN pi.user_id = #{currentUserId} THEN true
                ELSE false
            END as isSelf,
            pi.created_at as createdAt,
            pi.updated_at as updatedAt
        FROM post_interaction pi
        INNER JOIN user u ON pi.user_id = u.id
        LEFT JOIN alumni_info a ON u.id = a.user_id
        WHERE pi.post_id = #{postId}
          AND pi.type = 2
          AND pi.status = 1
          AND u.status = 1
          AND pi.parent_id = 0
        ORDER BY pi.created_at ASC
    </select>

    <!-- 查询回复列表 -->
    <select id="selectReplies" resultType="com.run.runsocialplatform.module.post.model.vo.CommentVO">
        SELECT
            pi.id,
            pi.post_id as postId,
            pi.user_id as userId,
            u.username,
            a.real_name as realName,
            u.avatar,
            pi.content,
            pi.parent_id as parentId,
            CASE
                WHEN pi.user_id = #{currentUserId} THEN true
                ELSE false
            END as isSelf,
            pi.created_at as createdAt,
            pi.updated_at as updatedAt
        FROM post_interaction pi
        INNER JOIN user u ON pi.user_id = u.id
        LEFT JOIN alumni_info a ON u.id = a.user_id
        WHERE pi.post_id = #{postId}
          AND pi.type = 2
          AND pi.status = 1
          AND u.status = 1
          AND pi.parent_id = #{parentId}
        ORDER BY pi.created_at ASC
    </select>

    <!-- 检查是否已点赞 -->
    <select id="checkLike" resultType="com.run.runsocialplatform.module.post.model.entity.PostInteraction">
        SELECT *
        FROM post_interaction
        WHERE post_id = #{postId}
          AND user_id = #{userId}
          AND type = 1
        LIMIT 1
    </select>

    <!-- 统计动态的点赞数 -->
    <select id="countLikes" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post_interaction
        WHERE post_id = #{postId}
          AND type = 1
          AND status = 1
    </select>

    <!-- 统计动态的评论数 -->
    <select id="countComments" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post_interaction
        WHERE post_id = #{postId}
          AND type = 2
          AND status = 1
    </select>

</mapper>

